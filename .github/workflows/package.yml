name: Package
on:
    push:
        tags:
            - '*'
permissions: write-all

jobs:
    change-version:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.outputstep.outputs.VERSION }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install git
              run: |
                  sudo apt-get update
                  sudo apt-get install -y git

            - id: outputstep
              run: |
                  echo "VERSION=$(git describe --tags | sed 's/-[0-9]*-.*//g')" >> "$GITHUB_OUTPUT"

            - name: Change Version for Windows
              run: |
                  sed -i "s/\"version\":.*/\"version\": \"$(git describe --tags | sed 's/-[0-9]*-.*//g')\",/g" package.json
                  sed -i "s/\"version\":.*/\"version\": \"$(git describe --tags | sed 's/-[0-9]*-.*//g')\"/g" src-tauri/tauri.conf.json
                  sed -i "s/version = \"0.0.0\"/version = \"$(git describe --tags | sed 's/-[0-9]*-.*//g')\"/g" src-tauri/Cargo.toml

            - name: Upload Artifacts for Windows
              uses: actions/upload-artifact@v4
              with:
                  name: source
                  path: ./*
                  include-hidden-files: true
                  if-no-files-found: error

    build-for-windows:
        needs: change-version
        runs-on: windows-latest
        steps:
            - uses: actions/download-artifact@v4
              with:
                  name: source

            - name: Setup Nodejs
              uses: actions/setup-node@v4
              with:
                  node-version: 21

            - name: Install Rust Stable
              uses: dtolnay/rust-toolchain@stable

            - name: install dependencies
              run: |
                  rustup target add x86_64-pc-windows-msvc
                  rustup toolchain install --force-non-host stable-x86_64-pc-windows-msvc

            - name: Cache Rust artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~\.cargo\registry
                      ~\.cargo\git
                      src-tauri\target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('src-tauri/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Install Dependencies
              run: pnpm install

            - name: Build and Package (NSIS only, updater disabled)
              run: |
                  pnpm tauri build -b nsis --target x86_64-pc-windows-msvc

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: windows_x86_64-pc-windows-msvc
                  path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*setup*
                  if-no-files-found: error

            - name: Upload Release
              if: startsWith(github.ref, 'refs/tags')
              uses: softprops/action-gh-release@v1
              with:
                  body_path: CHANGELOG
                  token: ${{ secrets.GITHUB_TOKEN }}
                  files: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*setup*

    # Disabled jobs intentionally per release requirement:
    # - build-extension
    # - build-for-macos
    # - build-for-windows-fix-runtime
    # - build-for-linux
    # - trigger-docs-update
    # - release-update
    # - homebrew
    # - winget
